# Copyright (c) 2019 SolarWinds, LLC.
# All rights reserved.

version: "2.1"

#########################################################################################################
#
# docker-compose to set up containers to run tests
#
# used by
# > rake docker
# > rake docker_tests
#
########################################################################################################
x-ao-env: &ao-env
  SW_APM_COLLECTOR: "/tmp/sw_apm_traces.bson"
  OBOE_STAGING: "true"
  SW_APM_GEM_TEST: "true"
  MONGO_SERVER: "ao-otel-ruby-mongo"
  RABBITMQ_SERVER: "ao-otel-ruby-rabbitmq"
  SW_APM_REPORTER: "file"
  # SW_APM_REPORTER: "ssl"   # only for java-collector
  SW_APM_REPORTER_FILE_SINGLE: "false"
  SW_APM_SERVICE_KEY: "${SW_APM_SERVICE_KEY}"
  SW_APM_TOKEN_BUCKET_CAPACITY: 10000
  SW_APM_TOKEN_BUCKET_RATE: 10000

  BUNDLE_GEMFILE: "gemfiles/unit.gemfile"
  DOCKER_MYSQL_PASS: "admin"
  DOCKER_PSQL_PASS: "docker"
  MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
  MYSQL_ROOT_PASSWORD: "admin"
  MYSQL_HOST: "ao-otel-ruby-mysql"
#  OBOE_VERSION: "10.1.0"
  POSTGRES_PASSWORD: "docker"
  POSTGRES_USER: "docker"
  POSTGRES_HOST: "ao-otel-ruby-postgres"
  QUERY_LOG_FILE: "/tmp/sw_apm_query_logs.txt"
  RUBY_ENV: "test"
  TEST_RUNS_TO_FILE: "true"
  SWO_OTEL_DEFAULT: "false"
#    - SIMPLECOV_COVERAGE=true
#    - OBOE_WIP=true
#    - SW_APM_DEBUG_LEVEL=6

x-ao-shared: &ao-shared
  mem_limit: 1G
  logging:
    options:
      max-file: "1"
      max-size: "100m"
  ports:
    - "3000"
  depends_on:
    - ao_otel_ruby_wait
  links:
    - ao_otel_ruby_wait
  stdin_open: true
  tty: true
  working_dir: /code/ruby-solarwinds

services:
  ruby_sw_otel_apm_ubuntu:
    container_name: ruby_sw_apm_ubuntu
    image: ruby_sw_apm_ubuntu
    build:
      context: .
      dockerfile: Dockerfile_ubuntu
    hostname: docker.ao.ubuntu
    << : *ao-shared
    volumes:
      - ../../:/code/ruby-solarwinds
      - ./.ruby_version_ubuntu:/code/ruby-solarwinds/.ruby-version
      - ../../../oboe/factory-output:/code/oboe/factory-output
      - ../../../oboe/liboboe:/code/oboe/liboboe
    environment:
      << : *ao-env
      SW_APM_HOSTNAME_ALIAS: "AO_RUBY_UBUNTU"

  ruby_sw_otel_apm_alpine:
    container_name: ruby_sw_apm_alpine
    image: ruby_sw_apm_alpine
    build:
      context: .
      dockerfile: ./Dockerfile_alpine
    hostname: docker.ao.alpine
    <<: *ao-shared
    volumes:
      - ../../:/code/ruby-solarwinds
      - ../../../oboe/factory-output:/code/oboe/factory-output
      - ../../../oboe/liboboe:/code/oboe/liboboe
      - ./.ruby_version_alpine:/code/ruby-solarwinds/.ruby-version
    environment:
      <<: *ao-env
      SW_APM_HOSTNAME_ALIAS: "AO_RUBY_ALPINE"

  ruby_sw_otel_apm_debian:
    container_name: ruby_sw_apm_debian
    image: ruby_sw_apm_debian
    build:
      context: .
      dockerfile: Dockerfile_debian
    hostname: docker.ao.debian
    << : *ao-shared
    volumes:
      - ../../:/code/ruby-solarwinds
      - ../../../oboe/factory-output:/code/oboe/factory-output
      - ../../../oboe/liboboe:/code/oboe/liboboe
      - ./.ruby_version_debian:/code/ruby-solarwinds/.ruby-version
    environment:
      << : *ao-env
      SW_APM_HOSTNAME_ALIAS: "AO_RUBY_DEBIAN"

  ruby_sw_otel_apm_centos:
    container_name: ruby_sw_apm_centos
    image: ruby_sw_apm_centos
    build:
      context: .
      dockerfile: Dockerfile_centos
    hostname: docker.ao.centos
    << : *ao-shared
    volumes:
      - ../../:/code/ruby-solarwinds
      - ../../../oboe/factory-output:/code/oboe/factory-output
      - ../../../oboe/liboboe:/code/oboe/liboboe
      - ./.ruby_version_centos:/code/ruby-solarwinds/.ruby-version
      - ../../../../repos/rack-cache/:/rack-cache
    environment:
      << : *ao-env
      SW_APM_HOSTNAME_ALIAS: "AO_RUBY_CENTOS"
    privileged: true

  ao-otel-ruby-rabbitmq:
    container_name: ao-otel-ruby-rabbitmq
    image: rabbitmq:3-management

  ao-otel-ruby-mysql:
    container_name: ao-otel-ruby-mysql
    platform: linux/amd64
    image: mysql:5.7.33
    command: --init-file /data/application/mysql_init.sql
    volumes:
      - ./mysql_init.sql:/data/application/mysql_init.sql
    environment:
      - MYSQL_ALLOW_EMPTY_PASSWORD=yes
      - MYSQL_ROOT_PASSWORD=admin

  ao-otel-ruby-mongo:
    container_name: ao-otel-ruby-mongo
    image: mongo:5

  ao-otel-ruby-postgres:
    container_name: ao-otel-ruby-postgres
    image: postgres:latest
    environment:
      POSTGRES_DB: "test_db"
      POSTGRES_USER: "docker"
      POSTGRES_PASSWORD: "docker"
    volumes:
      - ./postgres_init.sh:/docker-entrypoint-initdb.d/init-user-db.sh
      - ./postgresql.conf:/postgresql.conf
      - ../../log/postgresql:/var/log/postgresql
    command: postgres -c config_file=/postgresql.conf

  # the name has to be java-collector to make it work
  java-collector:
    container_name: java-collector
    image: "ghcr.io/librato/apm-agent-test-collector:v1.2.2"
    volumes:
      - ./../java_collector/settings.db:/settings.db
      - ./../java_collector/cert/server-grpc.pem:/server-grpc.pem
      - ./../java_collector/cert/server-grpc.crt:/server-grpc.crt
      - ./../java_collector/config-proxy-ao.json:/config.json
    logging:
      options:
        max-file: "1"
        max-size: 50m
    ports:
      - "8181:8181"
      - "12224:12224"
    command: java -jar apm-agent-test-collector.jar

  ao_otel_ruby_wait:
    container_name: ao_otel_ruby_wait
    image: waisbrot/wait
    depends_on:
      - ao-otel-ruby-rabbitmq
      - ao-otel-ruby-mysql
      - ao-otel-ruby-mongo
      - ao-otel-ruby-postgres
      - java-collector
    links:
      - ao-otel-ruby-rabbitmq
      - ao-otel-ruby-mysql
      - ao-otel-ruby-mongo
      - ao-otel-ruby-postgres
      - java-collector
