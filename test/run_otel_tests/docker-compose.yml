# Copyright (c) 2019 SolarWinds, LLC.
# All rights reserved.

version: "2.1"

#########################################################################################################
#
# docker-compose to set up containers to run tests
#
# used by
# > rake docker
# > rake docker_tests
#
########################################################################################################
x-swo-env: &swo-env
  SW_APM_COLLECTOR: "/tmp/sw_apm_traces.bson"
  OBOE_STAGING: "true"
  SW_APM_GEM_TEST: "true"
  SW_APM_REPORTER: "file"
  SW_APM_SERVICE_KEY: "SW_APM_SERVICE_KEY"
  BUNDLE_GEMFILE: "gemfiles/unit.gemfile"

x-swo-shared: &swo-shared
  mem_limit: 1G
  logging:
    options:
      max-file: "1"
      max-size: "100m"
  ports:
    - "3000"
  stdin_open: true
  tty: true
  working_dir: /code/ruby-solarwinds
  privileged: true

services:
  ruby_sw_otel_apm_ubuntu:
    container_name: ruby_sw_apm_ubuntu
    image: ubuntu:22.04
    hostname: docker.swo.ubuntu
    << : *swo-shared
    volumes:
      - ../../:/code/ruby-solarwinds
      - ../../../oboe/factory-output:/code/oboe/factory-output
      - ../../../oboe/liboboe:/code/oboe/liboboe
    environment:
      << : *swo-env
      SW_APM_HOSTNAME_ALIAS: "SWO_RUBY_UBUNTU"

  ruby_sw_otel_apm_alpine:
    container_name: ruby_sw_apm_alpine
    image: alpine:3.17
    hostname: docker.swo.alpine
    <<: *swo-shared
    volumes:
      - ../../:/code/ruby-solarwinds
      - ../../../oboe/factory-output:/code/oboe/factory-output
      - ../../../oboe/liboboe:/code/oboe/liboboe
    environment:
      <<: *swo-env
      SW_APM_HOSTNAME_ALIAS: "SWO_RUBY_ALPINE"

  ruby_sw_otel_apm_debian:
    container_name: ruby_sw_apm_debian
    image: debian:bullseye
    hostname: docker.swo.debian
    << : *swo-shared
    volumes:
      - ../../:/code/ruby-solarwinds
      - ../../../oboe/factory-output:/code/oboe/factory-output
      - ../../../oboe/liboboe:/code/oboe/liboboe
    environment:
      << : *swo-env
      SW_APM_HOSTNAME_ALIAS: "SWO_RUBY_DEBIAN"

  ruby_sw_otel_apm_amazonlinux:
    container_name: ruby_sw_apm_amazonlinux
    image: amazonlinux:2023
    hostname: docker.swo.amazonlinux
    << : *swo-shared
    volumes:
      - ../../:/code/ruby-solarwinds
      - ../../../oboe/factory-output:/code/oboe/factory-output
      - ../../../oboe/liboboe:/code/oboe/liboboe
      - ../../../../repos/rack-cache/:/rack-cache
    environment:
      << : *swo-env
      SW_APM_HOSTNAME_ALIAS: "SWO_RUBY_AMAZONLINUX"

  ruby_sw_otel_apm_ubuntu_development:
    container_name: ruby_sw_apm_ubuntu_development
    image: ruby_sw_apm_ubuntu_development
    build:
      context: .
      dockerfile: Dockerfile
    hostname: docker.swo.ubuntu.development
    << : *swo-shared
    volumes:
      - ../../:/code/ruby-solarwinds
      - ../../../oboe/factory-output:/code/oboe/factory-output
      - ../../../oboe/liboboe:/code/oboe/liboboe
    environment:
      << : *swo-env
      SW_APM_HOSTNAME_ALIAS: "SWO_RUBY_UBUNTU_DEVELOPMENT"

